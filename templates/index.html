{% extends "base.html" %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-4 mb-3">
                    <i class="fas fa-network-wired me-3"></i>
                    IP Ports Scanner
                </h1>
                <p class="lead mb-4">
                    Advanced network discovery and vulnerability analysis for internal networks
                </p>
                <div class="row text-center">
                    <div class="col-md-4">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <h6>Host Discovery</h6>
                    </div>
                    <div class="col-md-4">
                        <i class="fas fa-shield-alt fa-2x mb-2"></i>
                        <h6>Port Scanning</h6>
                    </div>
                    <div class="col-md-4">
                        <i class="fas fa-bug fa-2x mb-2"></i>
                        <h6>CVE Detection</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Scan Configuration -->
    <div class="scan-form">
        <h3 class="mb-4">
            <i class="fas fa-cog me-2"></i>
            Scan Configuration
        </h3>

        <form id="scanForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="subnets" class="form-label">
                            <i class="fas fa-sitemap me-1"></i>
                            Target Subnets (CIDR)
                        </label>
                        <textarea class="form-control" id="subnets" rows="4"
                            placeholder="192.168.1.0/24&#10;192.168.2.0/24&#10;10.0.0.0/16"
                            style="font-family: monospace;"></textarea>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter one subnet per line in CIDR format
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="maxThreads" class="form-label">
                            <i class="fas fa-bolt me-1"></i>
                            Max Threads
                        </label>
                        <input type="number" class="form-control" id="maxThreads" value="10" min="1" max="50">
                        <div class="form-text">Higher values = faster scanning</div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="enableCve" checked>
                        <label class="form-check-label" for="enableCve">
                            <i class="fas fa-bug me-1"></i>
                            Enable CVE Vulnerability Lookup
                        </label>
                        <div class="form-text">Requires internet connection</div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg" id="startScanBtn">
                        <i class="fas fa-play me-2"></i>Start Network Scan
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Scan Progress -->
    <div id="scanProgress" class="d-none mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Scan Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 25px; position: relative;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                        role="progressbar" style="width: 0%"></div>
                    <span id="progressText"
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); z-index: 10;">0%</span>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <h6 id="currentPhase" class="mb-2">Initializing...</h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">
                                    <i class="fas fa-server me-1"></i>
                                    Hosts: <span id="hostsCount">0</span>
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    <i class="fas fa-ethernet me-1"></i>
                                    Ports: <span id="portsCount">0</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex flex-column align-items-end">
                            <span id="scanDuration" class="badge bg-secondary mb-1">00:00</span>
                            <button id="cancelScanBtn" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-stop me-1"></i>Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Scans -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Active Scans
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-info me-2" onclick="testViewFunction()">
                            <i class="fas fa-bug"></i> Test View
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshActiveScans()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="activeScansContainer">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>No active scans</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="d-none mb-4">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Scan Results
                </h5>
                <div>
                    <button id="exportCsvBtn" class="btn btn-light btn-sm me-2">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </button>
                    <button id="clearResultsBtn" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-trash me-1"></i>Clear
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="resultsTable" class="table table-striped table-hover results-table">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-server me-1"></i>IP Address</th>
                                <th><i class="fas fa-desktop me-1"></i>Hostname</th>
                                <th><i class="fas fa-laptop me-1"></i>OS</th>
                                <th><i class="fas fa-ethernet me-1"></i>Port</th>
                                <th><i class="fas fa-cogs me-1"></i>Service</th>
                                <th><i class="fas fa-cube me-1"></i>Product</th>
                                <th><i class="fas fa-tag me-1"></i>Version</th>
                                <th><i class="fas fa-bug me-1"></i>CVEs</th>
                                <th><i class="fas fa-exclamation-triangle me-1"></i>Top CVE</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div id="statsSection" class="d-none mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card feature-card text-center">
                    <div class="card-body">
                        <i class="fas fa-server fa-2x text-primary mb-2"></i>
                        <h5 id="totalHosts">0</h5>
                        <small class="text-muted">Hosts Scanned</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card feature-card text-center">
                    <div class="card-body">
                        <i class="fas fa-ethernet fa-2x text-success mb-2"></i>
                        <h5 id="totalPorts">0</h5>
                        <small class="text-muted">Open Ports</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card feature-card text-center">
                    <div class="card-body">
                        <i class="fas fa-bug fa-2x text-warning mb-2"></i>
                        <h5 id="totalCves">0</h5>
                        <small class="text-muted">Vulnerabilities</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card feature-card text-center">
                    <div class="card-body">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                        <h5 id="highRiskCves">0</h5>
                        <small class="text-muted">High Risk CVEs</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentScanId = null;
    let progressInterval = null;
    let resultsTable = null;

    $(document).ready(function () {
        // Initialize DataTable
        resultsTable = $('#resultsTable').DataTable({
            "pageLength": 25,
            "order": [[0, "asc"]],
            "responsive": true,
            "columnDefs": [
                {
                    "targets": [7], // CVEs column
                    "render": function (data, type, row) {
                        if (data > 0) {
                            let badgeClass = data >= 5 ? 'bg-danger' : data >= 2 ? 'bg-warning' : 'bg-info';
                            return `<span class="badge ${badgeClass}">${data}</span>`;
                        }
                        return '<span class="text-muted">None</span>';
                    }
                },
                {
                    "targets": [8], // Top CVE column
                    "render": function (data, type, row) {
                        if (data && data.includes('CVE-')) {
                            let cvss = parseFloat(row[9]) || 0;
                            let className = cvss >= 7 ? 'cve-high' : cvss >= 4 ? 'cve-medium' : 'cve-low';
                            return `<span class="${className}">${data}</span>`;
                        }
                        return '<span class="text-muted">N/A</span>';
                    }
                }
            ]
        });

        // Load active scans on page load
        refreshActiveScans();
    });

    // Handle scan form submission
    $('#scanForm').submit(function (e) {
        e.preventDefault();

        const subnetsText = $('#subnets').val().trim();
        if (!subnetsText) {
            showAlert('Please enter at least one subnet', 'warning');
            return;
        }

        const subnets = subnetsText.split('\n').map(s => s.trim()).filter(s => s);
        const enableCve = $('#enableCve').is(':checked');
        const maxThreads = parseInt($('#maxThreads').val());

        startScan(subnets, enableCve, maxThreads);
    });

    function startScan(subnets, enableCve, maxThreads) {
        $('#startScanBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Starting...');

        $.ajax({
            url: '/start_scan',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                subnets: subnets,
                enable_cve: enableCve,
                max_threads: maxThreads
            }),
            success: function (response) {
                currentScanId = response.scan_id;
                $('#scanProgress').removeClass('d-none');
                startProgressMonitoring();
                refreshActiveScans();
                showAlert('Scan started successfully!', 'success');
            },
            error: function (xhr) {
                const error = xhr.responseJSON?.error || 'Failed to start scan';
                showAlert('Error: ' + error, 'danger');
                $('#startScanBtn').prop('disabled', false).html('<i class="fas fa-play me-2"></i>Start Network Scan');
            }
        });
    }

    function startProgressMonitoring() {
        if (progressInterval) clearInterval(progressInterval);

        progressInterval = setInterval(function () {
            if (currentScanId) {
                $.get(`/scan_status/${currentScanId}`, function (status) {
                    updateProgress(status);
                    updateScanHeader(status);

                    if (status.status === 'completed') {
                        clearInterval(progressInterval);
                        loadScanResults(currentScanId);
                        $('#startScanBtn').prop('disabled', false).html('<i class="fas fa-play me-2"></i>Start Network Scan');
                        refreshActiveScans();
                        showAlert('Scan completed successfully!', 'success');
                    } else if (status.status === 'failed') {
                        clearInterval(progressInterval);
                        $('#currentPhase').text('Scan failed: ' + status.current_phase);
                        $('#startScanBtn').prop('disabled', false).html('<i class="fas fa-play me-2"></i>Start Network Scan');
                        refreshActiveScans();
                        showAlert('Scan failed: ' + status.current_phase, 'danger');
                    }
                });
            }
        }, 2000);
    }

    function updateScanHeader(status) {
        const header = $('#scanProgress .card-header h5');

        if (status.status === 'completed') {
            header.html('<i class="fas fa-check-circle me-2"></i>Scan Completed');
            $('#scanProgress .card-header').removeClass('bg-primary bg-warning bg-danger').addClass('bg-success');
        } else if (status.status === 'failed') {
            header.html('<i class="fas fa-times-circle me-2"></i>Scan Failed');
            $('#scanProgress .card-header').removeClass('bg-primary bg-warning bg-success').addClass('bg-danger');
        } else if (status.progress >= 80) {
            header.html('<i class="fas fa-clock me-2"></i>Finalizing Scan');
            $('#scanProgress .card-header').removeClass('bg-primary bg-success bg-danger').addClass('bg-warning');
        } else {
            header.html('<i class="fas fa-spinner fa-spin me-2"></i>Scan Progress');
            $('#scanProgress .card-header').removeClass('bg-warning bg-success bg-danger').addClass('bg-primary');
        }
    }

    function updateProgress(status) {
        const progressBar = $('#progressBar');
        const progressText = $('#progressText');

        // Update progress width and text
        progressBar.css('width', status.progress + '%');
        progressText.text(status.progress + '%');

        // Update progress bar appearance based on status
        if (status.status === 'completed') {
            // Green for completed
            progressBar.removeClass('progress-bar-striped progress-bar-animated bg-primary bg-warning bg-danger')
                .addClass('bg-success');
            progressText.html('<i class="fas fa-check me-1"></i>' + status.progress + '% Complete');
        } else if (status.status === 'failed') {
            // Red for failed
            progressBar.removeClass('progress-bar-striped progress-bar-animated bg-primary bg-warning bg-success')
                .addClass('bg-danger');
            progressText.html('<i class="fas fa-times me-1"></i>Failed');
        } else if (status.progress >= 80) {
            // Orange/warning for near completion
            progressBar.removeClass('bg-primary bg-success bg-danger')
                .addClass('progress-bar-striped progress-bar-animated bg-warning');
            progressText.html('<i class="fas fa-spinner fa-spin me-1"></i>' + status.progress + '%');
        } else {
            // Blue for running
            progressBar.removeClass('bg-success bg-danger bg-warning')
                .addClass('progress-bar-striped progress-bar-animated bg-primary');
            progressText.html('<i class="fas fa-spinner fa-spin me-1"></i>' + status.progress + '%');
        }

        // Update other status information
        $('#currentPhase').text(status.current_phase);
        $('#hostsCount').text(status.hosts_found);
        $('#portsCount').text(status.ports_found);

        if (status.duration_seconds) {
            const minutes = Math.floor(status.duration_seconds / 60);
            const seconds = status.duration_seconds % 60;
            $('#scanDuration').text(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
        }
    }

    function loadScanResults(scanId) {
        console.log('Loading scan results for:', scanId);

        // Show loading indicator
        showAlert('Loading scan results...', 'info');

        $.ajax({
            url: `/scan_results/${scanId}`,
            method: 'GET',
            timeout: 30000, // 30 second timeout
            success: function (response) {
                console.log('Scan results received:', response);

                if (!response.data || response.data.length === 0) {
                    showAlert('No scan results found', 'warning');
                    return;
                }

                resultsTable.clear();

                let totalHosts = 0;
                let totalPorts = 0;
                let totalCves = 0;
                let highRiskCves = 0;

                const tableData = response.data.map(row => {
                    if (row.service !== 'No open ports') {
                        totalPorts++;
                        totalCves += row.cve_count || 0;
                        if (parseFloat(row.cvss_score) >= 7) {
                            highRiskCves++;
                        }
                    }

                    return [
                        row.ip || '',
                        row.hostname || '',
                        row.os || '',
                        row.port ? `${row.port}/${row.protocol}` : '',
                        row.service || '',
                        row.product || '',
                        row.version || '',
                        row.cve_count || 0,
                        row.top_cve || '',
                        row.cvss_score || ''
                    ];
                });

                resultsTable.rows.add(tableData);
                resultsTable.draw();

                // Update statistics
                const uniqueHosts = [...new Set(response.data.map(row => row.ip))];
                totalHosts = uniqueHosts.length;

                $('#totalHosts').text(totalHosts);
                $('#totalPorts').text(totalPorts);
                $('#totalCves').text(totalCves);
                $('#highRiskCves').text(highRiskCves);

                // Show results sections
                $('#resultsSection').removeClass('d-none');
                $('#statsSection').removeClass('d-none');

                // Scroll to results
                $('html, body').animate({
                    scrollTop: $('#resultsSection').offset().top - 100
                }, 1000);

                // Setup export button
                $('#exportCsvBtn').off('click').on('click', function () {
                    window.location.href = `/export_csv/${scanId}`;
                });

                showAlert(`Loaded ${totalHosts} hosts with ${totalPorts} open ports`, 'success');
            },
            error: function (xhr, status, error) {
                console.error('Error loading scan results:', error, xhr.responseText);
                let errorMsg = 'Failed to load scan results';

                if (xhr.status === 404) {
                    errorMsg = 'Scan results not found';
                } else if (xhr.status === 500) {
                    errorMsg = 'Server error loading results';
                } else if (status === 'timeout') {
                    errorMsg = 'Request timed out - large scan results may take time';
                }

                showAlert(errorMsg, 'danger');
            }
        });
    }

    function refreshActiveScans() {
        $.get('/active_scans', function (scans) {
            const container = $('#activeScansContainer');

            if (scans.length === 0) {
                container.html(`
                <div class="text-center text-muted py-3">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <p>No active scans</p>
                </div>
            `);
                return;
            }

            let html = '<div class="row">';
            scans.forEach(function (scan) {
                const statusClass = scan.status === 'running' ? 'status-running' :
                    scan.status === 'completed' ? 'status-completed' : 'status-failed';

                const statusIcon = scan.status === 'running' ? 'fa-spinner fa-spin' :
                    scan.status === 'completed' ? 'fa-check-circle' : 'fa-times-circle';

                // Create view button for completed scans
                let actionButton = '';
                if (scan.status === 'completed') {
                    actionButton = `
                    <button class="btn btn-sm btn-outline-primary view-results-btn" 
                            onclick="loadScanResults('${scan.scan_id}')" 
                            data-scan-id="${scan.scan_id}">
                        <i class="fas fa-eye"></i> View Results
                    </button>
                `;
                } else if (scan.status === 'running') {
                    actionButton = `
                    <button class="btn btn-sm btn-outline-secondary" disabled>
                        <i class="fas fa-clock"></i> In Progress
                    </button>
                `;
                } else if (scan.status === 'failed') {
                    actionButton = `
                    <button class="btn btn-sm btn-outline-danger" disabled>
                        <i class="fas fa-exclamation-triangle"></i> Failed
                    </button>
                `;
                }

                html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card scan-card">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-network-wired me-2"></i>
                                ${scan.subnets.join(', ')}
                            </h6>
                            <p class="card-text small">
                                <span class="${statusClass}">
                                    <i class="fas ${statusIcon} me-1"></i>${scan.status.toUpperCase()}
                                </span><br>
                                <i class="fas fa-server me-1"></i>Hosts: ${scan.hosts_found} | 
                                <i class="fas fa-ethernet me-1"></i>Ports: ${scan.ports_found}
                            </p>
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar" style="width: ${scan.progress}%"></div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${scan.current_phase}</small>
                                ${actionButton}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            });
            html += '</div>';

            container.html(html);

            // Add click handlers for view buttons
            $('.view-results-btn').on('click', function () {
                const btn = $(this);
                const scanId = btn.data('scan-id');

                // Show loading state
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');

                // Reset button after 5 seconds
                setTimeout(function () {
                    btn.prop('disabled', false).html('<i class="fas fa-eye"></i> View Results');
                }, 5000);
            });

        }).fail(function (xhr, status, error) {
            console.error('Failed to refresh active scans:', error);
            $('#activeScansContainer').html(`
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Failed to load active scans. <button class="btn btn-sm btn-outline-secondary ms-2" onclick="refreshActiveScans()">Retry</button>
            </div>
        `);
        });
    }

    // Clear results
    $('#clearResultsBtn').click(function () {
        if (confirm('Clear current results?')) {
            resultsTable.clear().draw();
            $('#resultsSection').addClass('d-none');
            $('#statsSection').addClass('d-none');
            $('#scanProgress').addClass('d-none');

            // Reset progress bar to initial state
            const progressBar = $('#progressBar');
            const progressText = $('#progressText');
            progressBar.removeClass('bg-success bg-danger bg-warning')
                .addClass('progress-bar-striped progress-bar-animated bg-primary')
                .css('width', '0%');
            progressText.html('0%');

            // Reset header
            $('#scanProgress .card-header h5').html('<i class="fas fa-spinner fa-spin me-2"></i>Scan Progress');
            $('#scanProgress .card-header').removeClass('bg-success bg-danger bg-warning').addClass('bg-primary');

            currentScanId = null;
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }
    });

    // Cancel scan
    $('#cancelScanBtn').click(function () {
        if (confirm('Cancel current scan?')) {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }

            // Reset progress bar
            const progressBar = $('#progressBar');
            const progressText = $('#progressText');
            progressBar.removeClass('bg-success bg-danger bg-warning')
                .addClass('progress-bar-striped progress-bar-animated bg-primary')
                .css('width', '0%');
            progressText.html('0%');

            // Reset header and hide progress section
            $('#scanProgress .card-header h5').html('<i class="fas fa-spinner fa-spin me-2"></i>Scan Progress');
            $('#scanProgress .card-header').removeClass('bg-success bg-danger bg-warning').addClass('bg-primary');
            $('#scanProgress').addClass('d-none');

            $('#startScanBtn').prop('disabled', false).html('<i class="fas fa-play me-2"></i>Start Network Scan');
            currentScanId = null;

            showAlert('Scan cancelled', 'info');
        }
    });

    // Auto-refresh active scans every 30 seconds
    setInterval(function () {
        if (!currentScanId || $('#scanProgress').hasClass('d-none')) {
            refreshActiveScans();
        }
    }, 30000);

    // Utility function to show alerts
    function showAlert(message, type) {
        const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

        $('.container').first().prepend(alertHtml);

        // Auto-remove after 5 seconds
        setTimeout(function () {
            $('.alert').fadeOut();
        }, 5000);
    }

    // Test function for debugging View button
    function testViewFunction() {
        console.log('Testing view function...');

        // Test if jQuery is working
        if (typeof $ === 'undefined') {
            alert('jQuery not loaded!');
            return;
        }

        // Test if DataTable is initialized
        if (!resultsTable) {
            alert('DataTable not initialized!');
            return;
        }

        // Test active scans endpoint
        $.get('/active_scans')
            .done(function (scans) {
                console.log('Active scans:', scans);

                if (scans.length === 0) {
                    showAlert('No scans found. Run a scan first, then click View when it completes.', 'info');
                    return;
                }

                const completedScans = scans.filter(s => s.status === 'completed');
                if (completedScans.length === 0) {
                    showAlert('No completed scans found. Wait for a scan to complete.', 'warning');
                    return;
                }

                const testScan = completedScans[0];
                showAlert(`Testing with scan: ${testScan.subnets.join(', ')}`, 'info');

                // Test loading results for the first completed scan
                loadScanResults(testScan.scan_id);
            })
            .fail(function (xhr, status, error) {
                console.error('Test failed:', error);
                showAlert('Test failed: ' + error, 'danger');
            });
    }
</script>
{% endblock %}